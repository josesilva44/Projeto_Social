{% extends 'tela_inicial/layout_base.html' %}

{% block conteudo %}
<div class="container py-4">
  <h2>Relat√≥rio da Aula: {{ aula.titulo }}</h2>

  <!-- INFORMA√á√ïES DA AULA -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Data prevista:</strong> {{ aula.data_prevista|date:"d/m/Y" }}</p>
          <p><strong>Classe:</strong> {{ aula.classe.nome }} ({{ aula.classe.igreja.nome }})</p>
        </div>
        <div class="col-md-6">
          <p><strong>Trimestre:</strong> {{ aula.trimestre.trimestre }}/{{ aula.trimestre.ano }}</p>
          <p>
            <strong>Status:</strong>
            {% if aula.concluida %}
              <span class="badge bg-success">‚úì Conclu√≠da</span>
            {% else %}
              <span class="badge bg-warning text-dark">‚è≥ Pendente</span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- DETALHES DO DI√ÅRIO -->
  {% if diarios %}
    <h4 class="mb-3">Detalhes do Di√°rio</h4>
    {% for d in diarios %}
      <div class="card mb-4">
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <p><strong>Data da Aula:</strong> {{ d.data_da_aula|date:"d/m/Y" }}</p>
              <p><strong>Alunos Presentes:</strong> {{ d.alunos_presentes }}</p>
              <p><strong>Alunos Ausentes:</strong> {{ d.alunos_ausentes }}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Visitantes:</strong> {{ d.visitantes }}</p>
              <p><strong>B√≠blias:</strong> {{ d.biblias }}</p>
              <p><strong>Revistas:</strong> {{ d.revistas }}</p>
              <p><strong>Ofertas:</strong> R$ {{ d.ofertas|floatformat:2 }}</p>
              <p><strong>D√≠zimos:</strong> R$ {{ d.dizimos|floatformat:2 }}</p>
            </div>
          </div>
          
          {% if d.observacoes %}
            <div class="mb-3">
              <strong>Observa√ß√µes:</strong>
              <p class="text-muted">{{ d.observacoes }}</p>
            </div>
          {% endif %}

          {% if d.presencas.all %}
            <div class="mb-3">
              <strong>Registro de Presen√ßa:</strong>
              <ul class="list-group list-group-sm">
                {% for presenca in d.presencas.all %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ presenca.aluno.nome }}
                    <span class="badge {% if presenca.status == 'P' %}bg-success{% else %}bg-danger{% endif %}">
                      {% if presenca.status == 'P' %}Presente{% else %}Ausente{% endif %}
                    </span>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}

    <!-- RESUMO GERAL -->
    {% if resumo %}
      <h4 class="mb-3">Resumo Geral</h4>
      <div class="card bg-dark">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-3">
              <h5 class="card-title">Presen√ßa</h5>
              <p class="card-text">Presentes: <strong>{{ resumo.alunos_presentes }}</strong></p>
              <p class="card-text">Ausentes: <strong>{{ resumo.alunos_ausentes }}</strong></p>
            </div>
            <div class="col-md-3">
              <h5 class="card-title">Materiais</h5>
              <p class="card-text">Visitantes: <strong>{{ resumo.visitantes }}</strong></p>
              <p class="card-text">B√≠blias: <strong>{{ resumo.biblias }}</strong></p>
              <p class="card-text">Revistas: <strong>{{ resumo.revistas }}</strong></p>
            </div>
            <div class="col-md-3">
              <h5 class="card-title">Finan√ßas</h5>
              <p class="card-text">Ofertas: <strong>R$ {{ resumo.ofertas|floatformat:2 }}</strong></p>
              <p class="card-text">D√≠zimos: <strong>R$ {{ resumo.dizimos|floatformat:2 }}</strong></p>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% else %}
    <div class="alert alert-info">
      üìù Nenhum di√°rio registrado para esta aula ainda.
    </div>
  {% endif %}

  <!-- BOT√ïES DE A√á√ÉO -->
  <div class="d-flex gap-2 mt-4">
    <!-- Bot√£o Preencher/Editar Di√°rio (s√≥ se aula n√£o foi conclu√≠da) -->
    {% if not aula.concluida %}
      <a href="{% url 'diario_registro' aula.id %}" class="btn btn-primary">üìù Preencher/Editar Di√°rio</a>
    {% else %}
      <button class="btn btn-primary" disabled title="Aula conclu√≠da - di√°rio n√£o pode ser editado">üìù Preencher/Editar Di√°rio</button>
    {% endif %}

    <!-- Bot√£o Concluir Aula (s√≥ para secret√°rio/superintendente se aula n√£o foi conclu√≠da) -->
    {% if user.is_authenticated and user.role|add:'X' != 'professorX' and not aula.concluida %}
      <form method="post" action="{% url 'aula_concluir' aula.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger" onclick="return confirm('‚ö†Ô∏è Tem certeza? Ap√≥s concluir a aula, o di√°rio n√£o poder√° mais ser editado. Esta a√ß√£o n√£o poder√° ser revertida.')">üîí Concluir Aula</button>
      </form>
    {% endif %}
  </div>

  <!-- Aviso de Aula Conclu√≠da -->
  {% if aula.concluida %}
    <div class="alert alert-danger mt-4" role="alert">
      <strong>üîí Aula Conclu√≠da:</strong> Esta aula foi finalizada e n√£o pode mais ser modificada.
    </div>
  {% endif %}
</div>


{% block footer %}{% endblock %}
{% endblock conteudo %}
